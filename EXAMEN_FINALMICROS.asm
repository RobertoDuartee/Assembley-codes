.INCLUDE "M16DEF.INC"
.ORG 0
RJMP MAIN
.ORG 2
RJMP ENABLE
.ORG 6
RJMP RFSH
.DEF BIN_LSB=R20

MAIN:
LDI R16,RAMEND(HIGH)
OUT SPH,R16
LDI R16,RAMEND(LOW)
OUT SPL,R16

;TECLADO MATRICIAL
CLR R16
OUT DDRC,R16

;SALIDA DE PWM, TIMER 1
SBI DDRD,4

;ENTRADA DEL CONTADOR DE PULSOS EXTERNO, TIMER 0
CBI DDRB,0

;INTERRUPCION EXTERNA
CBI DDRD,2

;DISPLAYS 7 SEG
SER R16
OUT DDRA,R16

;PIN PARA TRANSMISION
SBI DDRD,1

;PALABRAS DE CONTROL
LDI R16,0b01000000
OUT GICR,R16
LDI R16,0b00000010
OUT MCUCR,R16
LDI R16,0b10000000
OUT TIMSK,R16

;PALBRAS DE CONTROL PARA RUTINA DE RFSH TIMER2
LDI R16,51
OUT OCR2,R16
LDI R16,0b00001111
OUT TCCR2,R16

;PALBRAS DE CONTROL PARA CONTADOR DE PULSOS EXTERNO TIMER 0
LDI R16,0b00000111
OUT TCCR0,R16

;PALABRAS DE CONTROL PARA USART
LDI R16,0b10000110
OUT UCSRC,R16
LDI R16,0b00001000
OUT UCSRB,R16
LDI R16,103
OUT UBRRL,R16

SEI

;RAM DE DISPLAY
LDI XL,LOW(0X60)
LDI XH,HIGH(0X60)
LDI R22,3
LDI R23,0b11101111

CLR R16
STS 0x60,R16
STS 0x61,R16
STS 0x62,R16

;PERIODO PWM
LDI R16,HIGH(389)
OUT OCR1AH,R16
LDI R16,LOW(389)
OUT OCR1AL,R16



;RUTINA DE TECLADO
AGAIN:
CALL TECLADO
CPI R19,10
BREQ INGRESAR_DATOS1
CPI R19,11
BREQ INGRESAR_DATOS2
RJMP AGAIN

;------------DISTANCIA------

INGRESAR_DATOS1:
CALL TECLADO
CPI R19,10
BRLO ROT
CPI R19,12
BREQ EXEC1
RJMP INGRESAR_DATOS1

ROT:
LDS R16,0x61
STS 0X60,R16
STS 0X61,R19
RJMP INGRESAR_DATOS1


EXEC1:
BREQ CONTINUA


;------------SENTIDO----------
INGRESAR_DATOS2:
CALL TECLADO
CPI R19,5
BRLO GUARDAR
CPI R19,12
BREQ EXEC2
RJMP INGRESAR_DATOS2

GUARDAR:
STS 0X62,R19
RJMP INGRESAR_DATOS2


EXEC2:
BREQ CONTINUA

CONTINUA:
;SERVOMOTORES
LDS R16,0X62
CPI R16,3
BREQ PWM40
CPI R16,2
BREQ PWM20
CPI R16,1
BREQ PWM80
CPI R16,0
BREQ PWM60
RJMP INGRESAR_DATOS2

CONTINUA2
FIN: RJMP FIN

RFSH:
IN R16,SREG
PUSH R16

LD R0,X+
MOV R20,R23
ANDI R20,0XF0
ADD R0,R20
OUT PORTA,R0
ROL R23
DEC R22
BRNE SALIR
LDI XL,LOW(0X60)
LDI XH,HIGH(0X60)
LDI R22,3
LDI R23,0b11101111

SALIR:
POP R16
OUT SREG,R16
RETI

ENABLE:
IN R16,SREG
PUSH R16

;PALBRAS DE CONTROL PARA CONTADOR DE PULSOS EXTERNO TIMER 0
LDI R16,0b00000111
OUT TCCR0,R16


IN R16,TCNT0
CALL BCD_BIN
CP R16,BIN_LSB
CPI R16,4
BRLO APAGAR
RJMP SALIR


APAGAR:
;APAGAR MEDICION DE DISTANCIA
CLR R16
OUT TCCR0,R16

;APAGAR SERVOMOTRES
CLR R16
OUT OCR1A,R16
OUT OCR1B,R16

;TRAMSITIR
OUT UDR,BIN_LSB
polling:
SBIS UCSRA,UDRE
RJMP polling
LDS R16,0x63
OUT UDR,R16
polling1:
SBIS UCSRA,UDRE
RJMP polling1

SALIR:
POP R16
OUT SREG,R16
RETI

;-----CONFIGURACION DE DUTY CYCLE
;CILCO DE 20%
PWM20:
LDI R16,HIGH(77)
OUT ICR1H,R16
LDI R16,LOW(77)
OUT ICR1L,R16
CALL PWM
RJMP CONTINUA2

;CILCO DE 40%
PWM40:
LDI R16,HIGH(155)
OUT ICR1H,R16
LDI R16,LOW(155)
OUT ICR1L,R16
CALL PWM
RJMP CONTINUA2

;CILCO DE 40%
PWM60:
LDI R16,HIGH(233)
OUT ICR1H,R16
LDI R16,LOW(233)
OUT ICR1L,R16
CALL PWM
RJMP CONTINUA2

;CILCO DE 60%
PWM80:
LDI R16,HIGH(311)
OUT ICR1H,R16
LDI R16,LOW(311)
OUT ICR1L,R16
CALL PWM
RJMP CONTINUA2

;----PWM---
PWM:
LDI R16,0b00100010
OUT OCR1A,R16
LDI R16,0b00011101
OUT OCR1B,R16
RET

;---TECLADO MATRICIAL---
TECLADO:
LDI R17,4
LDI R18,0XFE
LDI R19,3

otrafila:
OUT PORTC,R18
NOP
IN R16,PINC
ANDI R16,0XF0
CPI R16,0XF0
BRNE tecla_pres
SEC
ROL R18
SUBI R19,-4
DEC R17
BRNE otrafila
LDI R19,0XFF
RET

tecla_press:
CALL delay10ms
IN R16,PINC
ANDI R16,0XF0
CPI R16,0XF0
BRNE tecla
LDI R19,0XFF
RET

tecla:

ROL R19
BRCC soltar
DEC R19
RJMP tecla

soltar:
IN R16,PINC
ANDI R16,0XF0
CPI R16,0XF0
BRNE soltar
CALL delay10ms
RET

;----------BCD 2 DIGITOS A 8 BITS---------;

BCD_BIN:


LDS R20,0X61
STS 0X71,R20
LDS R20,0X60
STS 0X70,R20

otro:

LDS R20,0x71
CPI R20,0
BRNE DEC_BCD
LDS R20,0x70
CPI R20,0
BRNE DEC_BCD
RET

DEC_BCD:
LDI R17,9
LDI YL,0X71
LDI YH,0

ciclo:
LD R20,Y
DEC R20
ST Y,R20
CPI R20,0XFF
BRNE INC_BIN
ST Y,R17
DEC YL
CPI YL,0X6F
BRNE ciclo

INC_BIN:
INC BIN_LSB
CPI BIN_LSB,0
BRNE otro
RET


delay10ms:	LDI R19, 104
	loop1:	LDI R20 ,255 
	loop2:	DEC R20 
			BRNE
			DEC R19
			BRNE 
RET

