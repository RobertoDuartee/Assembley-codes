;requerimientos
;señal de activacion en 0
;dos puertos como entrada de corriente, con valores negativos
;

.INCLUDE "m16def.inc"
.DEF CONT = R20
.DEF ANTERIORA = R21
.DEF ACTUALA = R22
.DEF ANTERIORB = R23
.DEF ACTUALB = R24

.ORG 0
RJMP MAIN
.ORG 2
RJMP INICIO
.ORG 4
RJMP STOP
.ORG 0x26
RJMP PULSE

MAIN:
LDI R16,HIGH(RAMEND)
OUT SPH,R16
LDI R16,LOW(RAMEND)
OUT SPL,R16

SER R16
;eNTRADA DE CORRIENTE COMPLEMENTO A DOS IA E IB
OUT PORTA,R16
OUT PORTB,R16

;SEÑAL DEL ENCODER, ACTIVA EN 0
CBI DDRD,2

;SEÑAL DE STOP, ACTIVA EN 0
CBI DDRD,3

;SEÑAL TIMER A
SBI DDRD,4

;SEÑAL TIMER B
SBI DDRD,5

;PALABRAS DE CONTROL INTERRUPCIONES EXTERNAS 0 Y 1
LDI R16,0b11000000
OUT GICR,R16
LDI R16,0b00001010
out MCUCR,R16

;INTERRUPCION DE TIMER
LDI R16,0b00000010
OUT TIMSK,R16
SEI

CANCUN: 
RJMP CANCUN


INICIO:
IN R16,SREG
PUSH R16

LDI R16,77
OUT OCR0,R16

LDI R16,0b00001101
OUT TCCR1B,R16

LDI CONT,10

POP R16
OUT SREG,R16

RETI


PULSE:
IN R16,SREG
PUSH R16

DEC CONT
BRNE SALIR

LDI CONT,10

;LECTURA DE PUERTOS
IN PINA,ACTUALA
IN PINB,ACTUALB

LDS ANTERIORA,0x60 ;R18 ANTERIOR, R16 NUEVO PUERTO A
STS 0x61,ANTERIORA
STS 0x60,ACTUALA

LDS ANTERIORB,0x62 ;R19 ANTERIOR, R17 NUEVO PUERTO B
STS 0x63,ANTERIORB
STS 0x62,ACTUALB

;COMPARACION A
COMPARAR_A:
CP ACTUALA,ANTERIORA
BRSH MAYORA

MENORA:
NEG R16
CP R18,R16
BREQ IGUALES_DSIGNA
;GENERAR PWM
LDI R16,HIGH(781)
OUT ICR1H,R16
LDI R16,LOW(781)
OUT ICR1L,R16
LDI R16,HIGH(155)
OUT OCR1AH,R16
LDI R16,LOW(155)
OUT OCR1AL,R16
CALL PWM
RJMP COMPARAR_B

MAYORA:
NEG R16
CP R18,R16
BREQ IGUALES
;GENERAR PWM
LDI R16,HIGH(781)
OUT ICR1H,R16
LDI R16,LOW(781)
OUT ICR1L,R16
LDI R16,HIGH(624)
OUT OCR1AH,R16
LDI R16,LOW(624)
OUT OCR1AL,R16
CALL PWM
RJMP COMPARAR_B

IGUALES_DSIGNA:
;GENERAR PWM
LDI R16,HIGH(781)
OUT ICR1H,R16
LDI R16,LOW(781)
OUT ICR1L,R16
LDI R16,HIGH(390)
OUT OCR1AH,R16
LDI R16,LOW(390)
OUT OCR1AL,R16
CALL PWM
RJMP COMPARAR_B



;COMPARACION B
COMPARAR_B:
CP R19,R17
BRSH MAYORB

MENORB:
NEG R16
CP R18,R16
BREQ IGUALES_DSIGNB
;GENERAR PWM
LDI R16,HIGH(781)
OUT ICR1H,R16
LDI R16,LOW(781)
OUT ICR1L,R16
LDI R16,HIGH(155)
OUT OCR1AH,R16
LDI R16,LOW(155)
OUT OCR1AL,R16
CALL PWM
RJMP COMPARAR_B

MAYORB:
NEG R16
CP R18,R16
BREQ IGUALES_DSIGNB
;GENERAR PWM
LDI R16,HIGH(781)
OUT ICR1H,R16
LDI R16,LOW(781)
OUT ICR1L,R16
LDI R16,HIGH(624)
OUT OCR1AH,R16
LDI R16,LOW(624)
OUT OCR1AL,R16
CALL PWM
RJMP COMPARAR_B

IGUALES_DSIGNB:
;GENERAR PWM
LDI R16,HIGH(781)
OUT ICR1H,R16
LDI R16,LOW(781)
OUT ICR1L,R16
LDI R16,HIGH(390)
OUT OCR1AH,R16
LDI R16,LOW(390)
OUT OCR1AL,R16
CALL PWM
RJMP COMPARAR_B

DEC R14
BRNE SALIR

LDI XL,LOW(0X60)
LDI XH,HIGH(0X60)
LDI R24


SALIR:
POP R16
OUT SREG,R16


PWM:
LDI R16,0b10100010
OUT TCCR1A,R16
LDI R16,0b00011101
OUT TCCR1B,R16

RETI




