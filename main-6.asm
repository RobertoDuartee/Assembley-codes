;
; Practica11.asm
;
; Created: 18/11/2020 07:59:00 a. m.
; Author : Roberto

.INCLUDE "M16DEF.INC"
.ORG 0
RJMP MAIN
.ORG 2
RJMP TECLA
.ORG 0x16
RJMP RX

MAIN:
LDI R16,HIGH(RAMEND)
OUT SPH,R16
LDI R16,LOW(RAMEND)
OUT SPL,R16

LDI R17,0X30

;LCD
SER R16
OUT DDRA,R16

;INTERRUPCION TECLA
CBI DDRD,2

;SALIDA SERIAL
SBI DDRD,1

;ENTRADA SERIAL
CBI DDRD,0

CALL INICIAR


;PALABRA DE CONTROL COMUNICACION SERIAL
LDI R16,0b10000110
OUT UCSRC,R16
LDI R16,0b10001000
OUT UCSRB,R16
LDI R16,51
OUT UBRRL,R16

;PALABRA DE INTERRUPCION EXTERNA
LDI R16,0b01000000
OUT GICR,R16
LDI R16,0b00000011
OUT MCUCR,R16

SEI


FIN: RJMP FIN

TECLA:
IN R16,SREG
PUSH R16


IN R16,PINC
ADD R16,R17
OUT UDR,R16

POP R16
OUT SREG,R16
RETI

RX:
IN R16,SREG
PUSH R16

IN R16,UDR
MOV R25,R16
CALL DISPLAY

POP R16
OUT SREG,R16
RETI

;-------------------CODIGOS NECESARIOS PARA EL LCD (INICIALIZACION Y COMANDOS)--------------

;--------------------INCIALIZAR
INICIAR:

LDI R26,0X28

;PRIMER 0X28
MOV R16,R26
CBR R16,0b00001111
OUT PORTA,R16
SBI PORTA,2
CALL delay40us
CBI PORTA,2
CALL delay40us

;SEGUNDO 0X28 NIBBLE ALTO
OUT PORTA,R16
SBI PORTA,2
CALL delay40us
CBI PORTA,2
CALL delay40us

;SEGUNDO 0X28 NIBBLE BAJO
MOV R16,R26
SWAP R16
CBR R16,0b00001111
OUT PORTA,R16
SBI PORTA,2
CALL delay40us
CBI PORTA,2
CALL delay40us

CALL delay10ms

;NIBBLE ALTO 0X0F
LDI R26,0b00001111
MOV R16,R26
CBR R16,0b00001111
OUT PORTA,R16
SBI PORTA,2
CALL delay40us
CBI PORTA,2
CALL delay40us
NOP

;NIBBLE BAJO 0X0F
MOV R16,R26
SWAP R16
CBR R16,0b00001111
OUT PORTA,R16
SBI PORTA,2
CALL delay40us
CBI PORTA,2
CALL delay40us
CALL delay10ms

;NIBBLE ALTO 0X01
LDI R26,0X01
MOV R16,R26
CBR R16,0b00001111
OUT PORTA,R16
SBI PORTA,2
CALL delay40us
CBI PORTA,2
CALL delay40us
NOP

;NIBBLE BAJO 0X01
MOV R16,R26
SWAP R16
CBR R16,0b00001111
OUT PORTA,R16
SBI PORTA,2
CALL delay40us
CBI PORTA,2
CALL delay10ms
RET


;--------------------------------DESPLAZAR
DESPLAZAR:
;NIBBLE ALTO
MOV R16,R27
;LDI R16,0b00010100
CBR R16,0b00001111
OUT PORTA,R16
SBI PORTA,2
CALL delay40us
CBI PORTA,2

;NIBBLE BAJO
;LDI R16,0b00010100
MOV R16,R27
SWAP R16
CBR R16,0b00001111
OUT PORTA,R16
SBI PORTA,2
CALL delay40us
CBI PORTA,2
RET

;--------------------------DISPLAY

DISPLAY:
;NIBBLE ALTO
;E,RW,RS

MOV R24,R25
CBR R24,0b00001111
OUT PORTA,R24
SBI PORTA,0
SBI PORTA,2
CALL delay40us
CBI PORTA,2
CALL delay40us

;NIBBLE BAJO

MOV R24,R25
SWAP R24
CBR R24,0b00001111
OUT PORTA,R24
SBI PORTA,0
SBI PORTA,2
CALL delay40us
CBI PORTA,2
CALL delay40us
RET


;-------------------------CLEAR DISPLAY
CLEARDISP:
;NIBBLE ALTO 0X01
LDI R26,0X01
MOV R16,R26
CBR R16,0b00001111
OUT PORTA,R16
SBI PORTA,2
CALL delay40us
CBI PORTA,2
CALL delay40us
NOP

;NIBBLE BAJO 0X01
MOV R16,R26
SWAP R16
CBR R16,0b00001111
OUT PORTA,R16
SBI PORTA,2
CALL delay40us
CBI PORTA,2
CALL delay10ms
RET


;----------------------NULLDISP
NULLDISP:
CALL DESPLAZAR
LDI R25,0X00
CALL DISPLAY
RET

;----------------------------------DELAYS----------------------------
delay10ms:
	LDI R20,104
	ciclo2:
	LDI R21,255
		ciclo1:
			DEC R21
			BRNE ciclo1
		DEC R20
		BRNE ciclo2
	RET

delay100ms:
	LDI R18,10
	ciclo3:
		CALL delay10ms
		DEC R18
		BRNE ciclo3
	RET

delay40us:
	LDI R22,103
	ciclo:
		DEC R22
		BRNE ciclo
	RET



