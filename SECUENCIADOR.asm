.INCLUDE "m16def.inc"
.ORG 0
RJMP MAIN
;cambiar por interrupcion de timer
.ORG 2
RJMP HAB
.ORG 4
RJMP SEQ

MAIN:
LDI R16,HIGH(RAMEND)
OUT SPH,R16
LDI R16,LOW(RAMEND)
OUT SPL,R16

;preparar puertos

;TECLADO
CLR R16
OUT DDRA,R16

;SALIDA DE SECUENCIA
SER R16
OUT DDRB,R16

;BOTON DE INICIO DE SECUENCIA
SBI DDRD,2

;BOTON DE PLAY
SBI DDRC,0

;BOTON DE STOP
SBI DDRC,1

;BOTON DE BORRAR
SBI DDRC,2

;PALABRAS DE CONTROL

LDI R16,0b01000000
OUT GICR,R16

LDI R16,0b00000011
OUT MCUCR,R16

;PUNTERO PARA RAM
LDI XH,HIGH(0x200)
LDI XL,LOW(0x200)

;CONTADOR
LDI R17,16

;ESTADO DEL HABILITADOR DE SECUENCIA
LDI R18,0

;ESTADO DEL PLAY PAUSE
LDI R19,255

AGAIN:
;PLAY
SBIC PINC,0
CALL PLAY_PAUSE

;STOP
SBIC PINC,1
CALL STOP
;ERASE

SBIC PINC,2
CALL ERASE
RJMP AGAIN

PLAY_PAUSE:

LD R16,X+
OUT PORTB,R16
CALL DELAY
DEC R17
BRNE SALIR

LDI XH,HIGH(0x200)
LDI XL,LOW(0x200)
LDI R17,16

SALIR:
RET

STOP:
LDI XH,HIGH(0x200)
LDI XL,LOW(0x200)
LDI R17,16
RET

ERASE:
CLR R16
ST X+,R16
DEC R17
BRNE SALIR
LDI XH,HIGH(0x200)
LDI XL,LOW(0x200)
LDI R17,16
SALIR:
RET

FIN: 
RJMP FIN

SEQ:
IN R16,SREG
PUSH R16

CPI R18,0
BREQ HABILITAR_ENTRADA

CPI R18,1
BREQ SECUENCIA_COMPLETA


HABILITAR_ENTRADA:
;cambiar por interrupcion de timer
LDI R16,0b11000000
OUT GICR,R16

LDI R16,0b00001111
OUT MCUCR,R16
INC R18
RJMP SALIR

SECUENCIA_COMPLETA:
;cambiar por interrupcion de timer
LDI R16,0b01000000
OUT GICR,R16

LDI R16,0b00000011
OUT MCUCR,R16
CLR R18

LDI XH,HIGH(0x200)
LDI XL,LOW(0x200)
LDI R17,16


SALIR:
POP R16
OUT SREG,R16
RETI

;cambiar por interrupcion de timer
HAB:
IN R16,SREG
PUSH R16

CALL LECTURA
DEC R17
BRNE SALIR

;SECUENCIA COMPLETA
LDI XH,HIGH(0x200)
LDI XL,LOW(0x200)
LDI R17,16


SALIR:
POP R16
OUT SREG,R16
RETI


LECTURA:
IN R16,PINA
ST X+,R16
RET


;LA SUBRUTINA DE DELAY LEERA UN VALOR ANAOLOGICO DE UN POTENCIOMETRO Y LO CARGARA PARA PODER DEFINIR LOS 
;BPM

DELAY:


RET