.INCLUDE "m16def.inc"
.ORG 0
RJMP MAIN
.ORG 2
RJMP BOTON
.ORG 0x26
RJMP RFSH

MAIN:
;PILA
LDI R16,HIGH(RAMEND)
OUT SPH,R16
LDI R16,LOW(RAMEND)
OUT SPL,R16

;PUERTOS
CBI DDRD,2

SER R16
OUT DDRB,R16

;PALABRAS DE CONTROL
LDI R16,0b01000000
OUT GICR,R16

LDI R16,0b00000010
OUT MCUCR,R16

LDI R16,0b00000010
OUT TIMSK,R16

;SEI
SEI

;PREPARAR TIMER
LDI R16,38
OUT OCR0,R16
LDI R16,0b00001101
OUT TCCR0,R16

;PUNTERO
LDI XH,HIGH(0X60)
LDI XL,LOW(0X60)

;CODIGO DE BARRIDO
LDI R25,0b11101111

;CONTADOR
LDI R24,4

;DISPLAY RAM
CLR R16
STS 0x60,R16
STS 0X61,R16
STS 0x62,R16
STS 0x63,R16


FIN: RJMP FIN

RFSH:
IN R16,SREG
PUSH R16

LD R0,X+
MOV R20,R25
ANDI R20,0XF0
ADD R0,R20
OUT PORTB,R0
ROL R25
DEC R24
BRNE SALIR
LDI XL,LOW(0X60)
LDI XH,HIGH(0X60)
LDI R24,4
LDI R25,0b11101111

POP R16
OUT SREG,R16
RETI


TECLA:
IN R16,SREG
PUSH R16
;ELIMINADORE DE REBOTE
CALL delay10ms
SBIC PIND,2
RJMP SALIR

SEI

;Esperar a que la tecla se suelte
polling:
SBIS PIND,2
RJMP polling
CALL delay10ms

;CONTADOR
CLR R17
UNIDADES:
LDS R16,0x63
INC R16
STS 0x63,R16
CPI R16,10
BRNE SALIR

DECENAS:
STS 0x63,R17
LDS R16,0x62
INC R16 
STS 0x62,R16
CPI R16,10
BRNE SALIR

CENTENAS:
STS 0x62,R17
LDS R16,0x61
INC R16
STS 0x61,R16
CPI R16,10
BRNE SALIR

MILLARES:
STS 0x61,R17
LDS R16,0x60
INC R16 
STS 0x60,R16
CPI R16,10
BRNE SALIR


SALIR:

POP R16
OUT SREG,R16
RETI


